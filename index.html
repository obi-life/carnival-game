<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bubble Pop Gauge Kids Coordination Game</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #667eea;
        --secondary: #764ba2;
        --accent: #ff6b6b;
        --success: #4ecdc4;
        --warning: #ffe66d;
        --bg-light: #f8fafc;
        --text-dark: #2d3748;
        --text-muted: #718096;
        --white: #ffffff;
        --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        font-family: "Comic Neue", cursive, system-ui, -apple-system, "Segoe UI",
          Roboto;
        color: var(--text-dark);
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        overflow-x: hidden;
      }

      /* Animated Background Elements */
      .bg-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .floating-element {
        position: absolute;
        font-size: 3rem;
        opacity: 0.3;
        animation: float 4s ease-in-out infinite;
      }

      .floating-element:nth-child(1) {
        top: 10%;
        left: 10%;
        animation-delay: 0s;
      }
      .floating-element:nth-child(2) {
        top: 20%;
        right: 16%;
        animation-delay: 0.5s;
      }
      .floating-element:nth-child(3) {
        bottom: 20%;
        left: 20%;
        animation-delay: 1s;
      }
      .floating-element:nth-child(4) {
        bottom: 32%;
        right: 12%;
        animation-delay: 1.5s;
      }
      .floating-element:nth-child(5) {
        top: 32%;
        left: 25%;
        animation-delay: 2s;
      }
      .floating-element:nth-child(6) {
        top: 40%;
        right: 33%;
        animation-delay: 2.5s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        50% {
          transform: translateY(-20px) rotate(5deg);
        }
      }

      /* Main Container */
      .container {
        position: relative;
        z-index: 10;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      /* Game Setup Section */
      .game-setup {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 2rem;
        box-shadow: var(--shadow-lg);
        max-width: 32rem;
        width: 100%;
        padding: 2rem;
        border: 4px solid rgba(255, 255, 255, 0.3);
        animation: slideIn 0.8s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .obi-logo {
        width: 2.5rem;
        height: 2.5rem;
        margin-right: 0.5rem;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        transition: transform 0.3s ease;
      }

      .obi-logo:hover {
        transform: scale(1.1);
      }

      .logo-section {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .logo {
        font-size: 3rem;
        margin-right: 0.5rem;
        animation: bounce 2s infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: scale(1) rotate(0deg);
        }
        50% {
          transform: scale(1.1) rotate(10deg);
        }
      }

      .tagline {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--secondary);
        letter-spacing: 0.05em;
      }

      .title {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 2.5rem;
        font-weight: 700;
        margin: 1rem 0;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      /* Info Box */
      .info-box {
        background: linear-gradient(135deg, #f0f9ff, #e0e7ff, #f3e8ff);
        border: 2px solid #c7d2fe;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        transition: transform 0.2s ease;
      }

      .info-box:hover {
        transform: scale(1.02);
      }

      .info-content {
        background: var(--white);
        border-radius: 0.75rem;
        padding: 1rem;
        border: 1px solid #e5e7eb;
      }

      .info-text {
        color: var(--text-dark);
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
        line-height: 1.5;
      }

      .metrics-badge {
        background: #4f46e5;
        color: var(--white);
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        display: inline-block;
        font-weight: 700;
        box-shadow: var(--shadow);
        border: 2px solid #3730a3;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 1rem;
        transition: transform 0.2s ease;
      }

      .form-group:hover {
        transform: scale(1.02);
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.75rem;
        border: 3px solid #d1d5db;
        background: var(--white);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        outline: none;
      }

      .form-input:focus,
      .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      /* Grid Layout for Settings */
      .settings-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .settings-item {
        transition: transform 0.2s ease;
      }

      .settings-item:hover {
        transform: scale(1.05);
      }

      .settings-input {
        width: 100%;
        padding: 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        border: 2px solid #d1d5db;
        background: var(--white);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        outline: none;
      }

      .settings-input:focus {
        border-color: var(--primary);
      }

      .settings-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.25rem;
      }

      .settings-unit {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      /* Start Button */
      .start-button {
        width: 100%;
        margin-top: 1.5rem;
        background: linear-gradient(135deg, #ec4899, #8b5cf6, #3b82f6);
        color: var(--white);
        font-weight: 700;
        padding: 1rem 2rem;
        border-radius: 1rem;
        border: none;
        box-shadow: var(--shadow);
        font-size: 1.125rem;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .start-button:hover {
        transform: scale(1.05);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
      }

      .start-button:active {
        transform: scale(0.95);
      }

      /* Game Zone */
      .game-zone {
        display: none;
        min-height: 100vh;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        position: relative;
      }

      .game-zone.active {
        display: block;
      }

      /* Game Header */
      .game-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 20;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 1rem;
        box-shadow: var(--shadow);
      }

      .game-title {
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
      }

      /* HUD */
      .hud {
        position: absolute;
        top: 80px;
        left: 1rem;
        right: 1rem;
        z-index: 15;
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1rem;
        align-items: center;
      }

      .timer-section {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        padding: 1rem;
        box-shadow: var(--shadow);
      }

      .timer-bar-container {
        position: relative;
        height: 1.25rem;
        background: #e0f2fe;
        border-radius: 0.75rem;
        overflow: hidden;
      }

      .timer-bar {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #06b6d4, #0891b2, #0e7490);
        transition: width 0.2s ease;
      }

      .timer-text {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: #164e63;
        font-weight: 700;
      }

      .stats {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .stat-pill {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.5rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-dark);
        box-shadow: var(--shadow);
      }

      /* Play Area */
      .play-area {
        position: absolute;
        top: 160px;
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
        background: radial-gradient(
          120% 100% at 50% -10%,
          #f0f9ff 0%,
          #e0f2fe 60%,
          #bae6fd 100%
        );
        border-radius: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
      }

      .fullscreen-btn {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        z-index: 10;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: var(--white);
        border: none;
        border-radius: 0.5rem;
        padding: 0.5rem;
        font-size: 0.875rem;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.2s ease;
      }

      .fullscreen-btn:hover {
        transform: scale(1.05);
      }

      .canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: block;
      }

      /* Overlays */
      .overlay {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        pointer-events: none;
        z-index: 10;
      }

      .overlay-panel {
        pointer-events: auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 2rem;
        border-radius: 1.5rem;
        box-shadow: var(--shadow-lg);
        max-width: 42rem;
        text-align: center;
      }

      .overlay h2 {
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
      }

      .overlay p {
        margin: 0.5rem 0;
        color: var(--text-muted);
        line-height: 1.5;
      }

      .button-row {
        display: flex;
        gap: 1rem;
        justify-content: center;
        align-items: center;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: var(--white);
        border: none;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.2s ease;
      }

      .btn:hover {
        transform: scale(1.05);
      }

      .btn.secondary {
        background: #f1f5f9;
        color: var(--text-dark);
      }

      /* Results Grid */
      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(11rem, 1fr));
        gap: 0.75rem;
        margin: 1rem 0;
      }

      .metric-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 1rem;
        padding: 1rem;
        text-align: center;
      }

      .metric-card h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.875rem;
        color: var(--text-muted);
      }

      .metric-value {
        font-size: 1.5rem;
        font-weight: 900;
        color: var(--text-dark);
      }

      .personality-text {
        margin-top: 1rem;
        font-weight: 600;
        font-size: 1rem;
        color: var(--primary);
      }

      /* Hidden class */
      .hidden {
        display: none !important;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 0.5rem;
        }

        .game-setup {
          padding: 1.5rem;
        }

        .settings-grid {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        .hud {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        .stats {
          justify-content: center;
        }

        .play-area {
          top: 200px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Animated Background -->
    <div class="bg-animation">
      <div class="floating-element">üé™</div>
      <div class="floating-element">üé†</div>
      <div class="floating-element">üé°</div>
      <div class="floating-element">üé≠</div>
      <div class="floating-element">ü´ß</div>
      <div class="floating-element">‚ú®</div>
    </div>

    <!-- Game Setup Section -->
    <div id="gameSetup" class="container">
      <div class="game-setup">
        <!-- Header -->
        <div class="header">
          <div class="logo-section">
            <img src="audio/obi-logo.svg" alt="OBI Logo" class="obi-logo" />
            <div class="logo">üíß</div>
            <span class="tagline">CARNIVAL PRESENTS</span>
          </div>

          <h1 class="title">Bubble Pop Gauge</h1>

          <!-- Info Box -->
          <div class="info-box">
            <div class="info-content">
              <p class="info-text">
                üéØ Tap or click the bubbles that show your name icon. Other
                bubbles are decoys. Pop as many as you can before time runs out!
              </p>
              <div class="metrics-badge">
                üìä Hand-Eye Coordination for Kids: score, accuracy, reaction
                time, targets/min, streak, misses
              </div>
            </div>
          </div>
        </div>

        <!-- Form -->
        <form id="setupForm">
          <!-- Player Name -->
          <div class="form-group">
            <label class="form-label">Name üëã</label>
            <input
              type="text"
              id="playerName"
              class="form-input"
              placeholder="Enter your awesome name!"
              required
            />
          </div>

          <!-- Icon Picker -->
          <div class="form-group">
            <label class="form-label">Icon ‚ú®</label>
            <select id="iconPicker" class="form-select">
              <option value="üêù">üêù Bee</option>
              <option value="üåû">üåû Sun</option>
              <option value="üåü">üåü Star</option>
              <option value="üçÄ">üçÄ Clover</option>
              <option value="üêæ">üêæ Paw</option>
              <option value="üê¶">üê¶ Bird</option>
              <option value="‚ú®">‚ú® Sparkle</option>
              <option value="üåà">üåà Rainbow</option>
              <option value="‚≠ê">‚≠ê Star</option>
              <option value="üê¨">üê¨ Dolphin</option>
              <option value="ü¶ã">ü¶ã Butterfly</option>
              <option value="üåª">üåª Flower</option>
            </select>
          </div>

          <!-- Game Settings Grid -->
          <div class="settings-grid">
            <div class="settings-item">
              <label class="settings-label">Time ‚è∞</label>
              <input
                type="number"
                id="gameTime"
                class="settings-input"
                value="45"
                min="15"
                max="180"
              />
              <span class="settings-unit">sec</span>
            </div>

            <div class="settings-item">
              <label class="settings-label">Bubbles ü´ß</label>
              <input
                type="number"
                id="bubbleCount"
                class="settings-input"
                value="7"
                min="1"
                max="25"
              />
              <span class="settings-unit">count</span>
            </div>

            <div class="settings-item">
              <label class="settings-label">Age üéÇ</label>
              <input
                type="number"
                id="playerAge"
                class="settings-input"
                value="5"
                min="1"
                max="18"
              />
              <span class="settings-unit">yrs</span>
            </div>
          </div>

          <!-- Start Button -->
          <button type="submit" class="start-button">
            üöÄ Start the Carnival Adventure!
          </button>
        </form>
      </div>
    </div>

    <!-- Game Zone Section -->
    <div id="gameZone" class="game-zone">
      <!-- Game Header -->
      <div class="game-header">
        <h1 class="game-title">üíß Bubble Pop Gauge</h1>
      </div>

      <!-- HUD -->
      <div class="hud">
        <div class="timer-section">
          <div class="timer-bar-container">
            <div class="timer-bar" id="timeBar"></div>
            <div class="timer-text" id="timeTip">Ready</div>
          </div>
        </div>
        <div class="stats">
          <span class="stat-pill" id="pillHits">Hits: 0</span>
          <span class="stat-pill" id="pillMiss">Misses: 0</span>
          <span class="stat-pill" id="pillAcc">Accuracy: 0%</span>
          <span class="stat-pill" id="pillRT">Avg RT: 0 ms</span>
          <span class="stat-pill" id="pillTPM">Targets/min: 0</span>
          <span class="stat-pill" id="pillStreak">Streak: 0</span>
        </div>
      </div>

      <!-- Play Area -->
      <div class="play-area">
        <button class="fullscreen-btn" id="fullscreenBtn">‚õ∂ Fullscreen</button>
        <canvas id="scene" class="canvas"></canvas>

        <!-- Start Overlay -->
        <div class="overlay" id="startOverlay">
          <div class="overlay-panel">
            <h2>Pop the bubbles!</h2>
            <p>
              Tap or click the bubbles that show your name icon. Other bubbles
              are decoys. Pop as many as you can before time runs out.
            </p>
            <div class="button-row">
              <div style="font-size: 0.8rem; color: var(--text-muted)">
                Metrics captured: <strong>hand-eye score</strong>,
                <strong>accuracy</strong>, <strong>reaction time</strong>,
                <strong>targets/min</strong>, <strong>streak</strong>,
                <strong>misses</strong>.
              </div>
              <button class="btn" id="startGameBtn">Start Game</button>
            </div>
          </div>
        </div>

        <!-- Results Overlay -->
        <div class="overlay hidden" id="resultsOverlay">
          <div class="overlay-panel">
            <h2>Great job, <span id="resName">Player</span>!</h2>
            <p>Here are your results:</p>
            <div class="results-grid" id="resultsGrid"></div>
            <div class="personality-text" id="personalityDesc"></div>
            <div class="button-row">
              <div style="font-size: 0.75rem; color: var(--text-muted)">
                Scores are saved locally on this device.
              </div>
              <button class="btn secondary" id="playAgain">Play again</button>
              <button class="btn" id="exportCsv">Export CSV</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audio Elements -->
    <audio id="bgMusic" src="audio/cc.mp3" loop></audio>
    <audio id="popSound" src="audio/bubble.mp3"></audio>
    <audio id="errorSound" src="audio/error.mp3"></audio>

    <script>
      // Utility functions
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const rand = (a, b) => Math.random() * (b - a) + a;
      const now = () => performance.now();

      // Game state
      let gameConfig = {
        playerName: "",
        icon: "üêù",
        gameTime: 45,
        bubbleCount: 7,
        playerAge: 5,
      };

      let gameState = {
        running: false,
        startTime: 0,
        bubbles: [],
        metrics: {
          hits: 0,
          misses: 0,
          streak: 0,
          bestStreak: 0,
          targetSpawns: 0,
          reactionTimes: [],
          taps: 0,
        },
        colorIndex: 0,
      };

      // Canvas setup
      const canvas = document.getElementById("scene");
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;

      function resizeCanvas() {
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        if (canvas.width !== width * dpr || canvas.height !== height * dpr) {
          canvas.width = width * dpr;
          canvas.height = height * dpr;
          ctx.scale(dpr, dpr);
        }
      }

      // Colors for bubbles
      const colorsRainbow = [
        "rgba(255, 0, 0, ALPHA)", // Red
        "rgba(255, 127, 0, ALPHA)", // Orange
        "rgba(255, 255, 0, ALPHA)", // Yellow
        "rgba(0, 255, 0, ALPHA)", // Green
        "rgba(0, 0, 255, ALPHA)", // Blue
        "rgba(75, 0, 130, ALPHA)", // Indigo
        "rgba(148, 0, 211, ALPHA)", // Violet
      ];

      // Bubble class
      class Bubble {
        constructor(x, y, r, vx, vy, text, icon, isTarget, color) {
          this.x = x;
          this.y = y;
          this.r = r;
          this.vx = vx;
          this.vy = vy;
          this.text = text;
          this.icon = icon;
          this.isTarget = isTarget;
          this.birth = now();
          this.alpha = 0;
          this.color = color;
        }

        update(dt) {
          this.x += this.vx * dt;
          this.y += this.vy * dt;

          // Bounce off walls
          if (this.x - this.r < 0) {
            this.x = this.r;
            this.vx = Math.abs(this.vx);
          }
          if (this.x + this.r > canvas.clientWidth) {
            this.x = canvas.clientWidth - this.r;
            this.vx = -Math.abs(this.vx);
          }
          if (this.y - this.r < 0) {
            this.y = this.r;
            this.vy = Math.abs(this.vy);
          }
          if (this.y + this.r > canvas.clientHeight) {
            this.y = canvas.clientHeight - this.r;
            this.vy = -Math.abs(this.vy);
          }

          // Fade in
          const age = now() - this.birth;
          this.alpha = clamp(age / 400, 0, 1);
        }

        draw(ctx) {
          const baseColor = this.color.replace(
            "ALPHA",
            (this.alpha * 0.8).toFixed(2)
          );
          const grd = ctx.createRadialGradient(
            this.x - this.r * 0.4,
            this.y - this.r * 0.4,
            this.r * 0.2,
            this.x,
            this.y,
            this.r
          );
          grd.addColorStop(0, `rgba(255, 255, 255, ${this.alpha * 0.9})`);
          grd.addColorStop(0.5, baseColor);
          grd.addColorStop(1, `rgba(135, 206, 235, ${this.alpha * 0.2})`);

          ctx.save();
          ctx.globalAlpha = this.alpha;

          // Main bubble
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
          ctx.fillStyle = grd;
          ctx.fill();

          // Border
          ctx.lineWidth = 2;
          ctx.strokeStyle = "rgba(180, 220, 255, 0.9)";
          ctx.stroke();

          // Highlight
          ctx.beginPath();
          ctx.ellipse(
            this.x - this.r * 0.35,
            this.y - this.r * 0.35,
            this.r * 0.4,
            this.r * 0.2,
            -0.6,
            0,
            Math.PI * 2
          );
          ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
          ctx.fill();

          // Icon and text
          ctx.fillStyle = "#08324a";
          ctx.font = `bold ${Math.max(
            16,
            this.r * 0.5
          )}px Comic Neue, system-ui`;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(this.icon, this.x, this.y - this.r * 0.1);

          ctx.font = `600 ${Math.max(
            12,
            this.r * 0.25
          )}px Comic Neue, system-ui`;
          ctx.fillText(this.text, this.x, this.y + this.r * 0.3);

          ctx.restore();
        }

        contains(px, py) {
          const dx = px - this.x;
          const dy = py - this.y;
          return Math.hypot(dx, dy) <= this.r;
        }
      }

      // Create random bubble
      function randomBubble(isTarget) {
        const margin = 60;
        const r = rand(28, 60);
        const x = rand(margin, canvas.clientWidth - margin);
        const y = rand(margin, canvas.clientHeight - margin);
        const vx = rand(-0.08, 0.08);
        const vy = rand(-0.02, 0.02);

        const decoyIcons = [
          "üêù",
          "üåû",
          "üåü",
          "üçÄ",
          "üêæ",
          "üê¶",
          "‚ú®",
          "üåà",
          "‚≠ê",
          "üê¨",
          "ü¶ã",
          "üåª",
        ];
        const decoyNames = [
          "Sun",
          "Sky",
          "Joy",
          "Bee",
          "Kit",
          "Pip",
          "Zee",
          "Mio",
        ];

        const text = isTarget
          ? gameConfig.playerName
          : decoyNames[Math.floor(rand(0, decoyNames.length))];
        const icon = isTarget
          ? gameConfig.icon
          : decoyIcons[Math.floor(rand(0, decoyIcons.length))];

        if (isTarget) gameState.metrics.targetSpawns++;

        const color =
          colorsRainbow[gameState.colorIndex % colorsRainbow.length];
        gameState.colorIndex++;

        return new Bubble(x, y, r, vx, vy, text, icon, isTarget, color);
      }

      // Game loop
      let last = now();
      function gameLoop() {
        if (!gameState.running) return;

        const t = now();
        const dt = t - last;
        last = t;

        const elapsed = t - gameState.startTime;
        const remaining = clamp(
          gameConfig.gameTime * 1000 - elapsed,
          0,
          gameConfig.gameTime * 1000
        );
        const pct = (remaining / (gameConfig.gameTime * 1000)) * 100;

        document.getElementById("timeBar").style.width = pct + "%";
        const timeText =
          remaining > 0
            ? `Time left: ${(remaining / 1000).toFixed(1)}s`
            : "Done";
        document.getElementById("timeTip").textContent = timeText;

        if (remaining <= 0) {
          endGame();
          return;
        }

        // Remove old bubbles
        gameState.bubbles = gameState.bubbles.filter(
          (b) => now() - b.birth < 2000
        );

        // Ensure we have target bubbles
        const hasTarget = gameState.bubbles.some((b) => b.isTarget);

        // Spawn new bubbles
        while (gameState.bubbles.length < gameConfig.bubbleCount) {
          const isTarget = hasTarget ? Math.random() > 0.5 : true;
          gameState.bubbles.push(randomBubble(isTarget));
        }

        // Update and draw
        resizeCanvas();
        ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);

        for (const b of gameState.bubbles) {
          b.update(dt);
          b.draw(ctx);
        }

        requestAnimationFrame(gameLoop);
      }

      // Handle clicks/taps
      function handleTap(clientX, clientY) {
        if (!gameState.running) return;

        gameState.metrics.taps++;

        const rect = canvas.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        for (let i = gameState.bubbles.length - 1; i >= 0; i--) {
          const b = gameState.bubbles[i];
          if (b.contains(x, y)) {
            if (b.isTarget) {
              const rt = now() - b.birth;
              gameState.metrics.hits++;
              gameState.metrics.streak++;
              gameState.metrics.bestStreak = Math.max(
                gameState.metrics.bestStreak,
                gameState.metrics.streak
              );
              gameState.metrics.reactionTimes.push(rt);
              // Play sound
              const popAudio = document.getElementById("popSound");
              if (popAudio) {
                popAudio.currentTime = 0;
                popAudio.play();
              }
            } else {
              gameState.metrics.misses++;
              gameState.metrics.streak = 0;
              const missAudio = document.getElementById("errorSound");
              if (missAudio) {
                missAudio.currentTime = 0;
                missAudio.play();
              }
            }

            gameState.bubbles.splice(i, 1);
            updateHUD();
            return;
          }
        }

        // Missed
        gameState.metrics.misses++;
        gameState.metrics.streak = 0;
        updateHUD();
      }

      // Event listeners
      canvas.addEventListener("click", (e) => handleTap(e.clientX, e.clientY));
      canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        const te = e.changedTouches[0];
        handleTap(te.clientX, te.clientY);
      });

      // Update HUD
      function updateHUD() {
        const acc =
          (gameState.metrics.hits / Math.max(1, gameState.metrics.taps)) * 100;
        const tpm =
          (gameState.metrics.targetSpawns /
            Math.max(1, now() - gameState.startTime)) *
          60000;
        const avgRT = gameState.metrics.reactionTimes.length
          ? gameState.metrics.reactionTimes.reduce((a, b) => a + b, 0) /
            gameState.metrics.reactionTimes.length
          : 0;

        document.getElementById("pillHits").textContent =
          "Hits: " + gameState.metrics.hits;
        document.getElementById("pillMiss").textContent =
          "Misses: " + gameState.metrics.misses;
        document.getElementById("pillAcc").textContent =
          "Accuracy: " + acc.toFixed(0) + "%";
        document.getElementById("pillRT").textContent = gameState.metrics
          .reactionTimes.length
          ? "Avg RT: " + avgRT.toFixed(0) + " ms"
          : "Avg RT: 0 ms";
        document.getElementById("pillTPM").textContent = isFinite(tpm)
          ? "Targets/min: " + tpm.toFixed(1)
          : "Targets/min: 0";
        document.getElementById(
          "pillStreak"
        ).textContent = `Streak: ${gameState.metrics.streak}`;
      }

      // Start game
      function startGame() {
        gameState.running = true;
        gameState.startTime = now();
        gameState.bubbles = [];

        // Reset metrics
        gameState.metrics = {
          hits: 0,
          misses: 0,
          streak: 0,
          bestStreak: 0,
          targetSpawns: 0,
          reactionTimes: [],
          taps: 0,
        };
        gameState.colorIndex = 0;

        // Hide start overlay
        document.getElementById("startOverlay").classList.add("hidden");

        // Start background music
        const bgMusic = document.getElementById("bgMusic");
        if (bgMusic) {
          bgMusic.volume = 0.3;
          bgMusic.play();
        }

        updateHUD();
        gameLoop();
      }

      // End game
      function endGame() {
        gameState.running = false;

        // Stop music
        const bgMusic = document.getElementById("bgMusic");
        if (bgMusic) {
          bgMusic.pause();
        }

        showResults();
      }

      // Show results
      function showResults() {
        // Play completion sound
        const completionSound = document.getElementById("completionSound");
        if (completionSound) {
          completionSound.currentTime = 0;
          completionSound.play().catch(e => console.log("Audio play failed:", e));
        }

        const acc =
          gameState.metrics.hits / Math.max(1, gameState.metrics.taps);
        const avgRT = gameState.metrics.reactionTimes.length
          ? gameState.metrics.reactionTimes.reduce((a, b) => a + b, 0) /
            gameState.metrics.reactionTimes.length
          : 0;
        const streakScore = clamp(gameState.metrics.bestStreak / 10, 0, 1);
        const rtScore = clamp((3000 - avgRT) / 3000, 0, 1);
        const score = Math.round(acc * 50 + rtScore * 30 + streakScore * 20);

        document.getElementById("resName").textContent = gameConfig.playerName;

        const resultsGrid = document.getElementById("resultsGrid");
        resultsGrid.innerHTML = `
        <div class="metric-card">
          <h4>Final Score</h4>
          <div class="metric-value">${score}</div>
        </div>
        <div class="metric-card">
          <h4>Accuracy</h4>
          <div class="metric-value">${(acc * 100).toFixed(0)}%</div>
        </div>
        <div class="metric-card">
          <h4>Hits</h4>
          <div class="metric-value">${gameState.metrics.hits}</div>
        </div>
        <div class="metric-card">
          <h4>Best Streak</h4>
          <div class="metric-value">${gameState.metrics.bestStreak}</div>
        </div>
        <div class="metric-card">
          <h4>Avg Reaction</h4>
          <div class="metric-value">${avgRT.toFixed(0)}ms</div>
        </div>
        <div class="metric-card">
          <h4>Targets/min</h4>
          <div class="metric-value">${(
            gameState.metrics.targetSpawns /
            (gameConfig.gameTime / 60)
          ).toFixed(1)}</div>
        </div>
      `;

        // Personality detection
        const personalities = [
          "Curious explorer! You love trying everything.",
          "Bright spark! Your energy lights up the game.",
          "Steady star! You keep going with great focus.",
          "Playful adventurer! You dive into the fun.",
          "Quick learner! You're catching on fast.",
          "Joyful jumper! You make every pop count.",
          "Bouncy buddy! Your enthusiasm is awesome.",
        ];

        document.getElementById("personalityDesc").textContent =
          personalities[Math.floor(Math.random() * personalities.length)];

        document.getElementById("resultsOverlay").classList.remove("hidden");
      }

      // Setup form submission
      document.getElementById("setupForm").addEventListener("submit", (e) => {
        e.preventDefault();

        gameConfig.playerName = document
          .getElementById("playerName")
          .value.trim();
        gameConfig.icon = document.getElementById("iconPicker").value;
        gameConfig.gameTime = parseInt(
          document.getElementById("gameTime").value
        );
        gameConfig.bubbleCount = parseInt(
          document.getElementById("bubbleCount").value
        );
        gameConfig.playerAge = parseInt(
          document.getElementById("playerAge").value
        );

        if (!gameConfig.playerName) {
          alert("Please enter your name! üòä");
          return;
        }

        // Switch to game zone
        document.getElementById("gameSetup").style.display = "none";
        document.getElementById("gameZone").classList.add("active");

        resizeCanvas();
      });

      // Game controls
      document
        .getElementById("startGameBtn")
        .addEventListener("click", startGame);

      document.getElementById("playAgain").addEventListener("click", () => {
        location.reload();
      });

      document.getElementById("exportCsv").addEventListener("click", () => {
        // Simple CSV export
        const csvData = [
          ["Metric", "Value"],
          ["Player Name", gameConfig.playerName],
          ["Hits", gameState.metrics.hits],
          ["Misses", gameState.metrics.misses],
          [
            "Accuracy",
            (
              (gameState.metrics.hits / Math.max(1, gameState.metrics.taps)) *
              100
            ).toFixed(2) + "%",
          ],
          ["Best Streak", gameState.metrics.bestStreak],
          [
            "Average Reaction Time",
            gameState.metrics.reactionTimes.length
              ? (
                  gameState.metrics.reactionTimes.reduce((a, b) => a + b, 0) /
                  gameState.metrics.reactionTimes.length
                ).toFixed(0) + "ms"
              : "0ms",
          ],
        ];

        const csvContent = csvData.map((row) => row.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `bubble-pop-results-${gameConfig.playerName}-${
          new Date().toISOString().split("T")[0]
        }.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      });

      // Fullscreen functionality
      document.getElementById("fullscreenBtn").addEventListener("click", () => {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          document.getElementById("gameZone").requestFullscreen();
        }
      });

      // Initialize canvas
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();
    </script>
  </body>
</html>
